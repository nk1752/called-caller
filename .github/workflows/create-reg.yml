name: create registration

on:
  workflow_call:
    inputs:
      flex-name:
        type: string
        required: true

jobs:
  register-renew:
    runs-on: ubuntu-latest
    
    steps:

      - name: echo
        run: |
          echo "caller send: ${{ inputs.flex-name }}"

      - name: checkout
        uses: actions/checkout@v4.1.6

      - name: read config
        run: |
          echo "reading config"
          jq . config.json

      # Set up BuildKit Docker container builder to be able to build
      # multi-platform images and export cache
      # https://github.com/docker/setup-buildx-action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      - name: pull image
        run: |
          docker pull mulesoft/flex-gateway:latest

      # list docker images
      - name: list docker images
        run: |
          docker images

      # check os version on ubuntu
      - name: check os version
        run: |
          cat /etc/os-release

      - name: search
        id: search
        run: |
          # search for element in config.json elements
          flex_key=${{ inputs.flex-name }}
          
          echo "creating directory: $flex_key"
          mkdir -p $flex_key
          ls -l
          
          flex_name=$(jq -r --arg flex_key "$flex_key" .[flex_key] config.json)

          oper=$(jq -r --arg key "$key" '.[$key].oper' config.json)
          echo "operation found: $oper"
            
          if [[ $oper == "register" ]]
          then  
            echo "registering..."

            sudo docker run --entrypoint flexctl \
              -v "$(pwd)/temp":/registration -u $UID mulesoft/flex-gateway \
              registration create \
              --client-id=b95726291f564ae2942ac2c4ecc46311 \
              --client-secret=59dB6D7A84bd442bAfE7422233a82902 \
              --environment=2c6f18bb-03e2-4874-a489-7216df5b5bc2 \
              --connected=true \
              --organization=a6ea8ce7-6d5f-41ee-a802-5505e8833854 \
              --output-directory=/registration \
              $flex_name

              ls -l
              cat ./$key/registration.yaml
              

          elif [[ $oper == "renew" ]]
          then  
            echo "renewing..."
          else
            echo "operation $oper skipping..."
          fi  
          

      